const CACHE_365_KEY = "usd_eur_rates_365";
const CACHE_365_DATE_KEY = "usd_eur_rates_365_date";
const CACHE_CURR_RATE_KEY = "usd_eur_current_rate";
const CACHE_CURR_RATE_DATE_KEY = "usd_eur_current_rate_date";

const today = new Date().toISOString().split("T")[0];

async function fetch365DayRates() {
  const cachedData = localStorage.getItem(CACHE_365_KEY);
  const cachedDate = localStorage.getItem(CACHE_365_DATE_KEY);

  if (cachedData && cachedDate === today) {
    return JSON.parse(cachedData);
  }

  const endDate = today;
  const startDateObj = new Date();
  startDateObj.setDate(startDateObj.getDate() - 365);
  const startDate = startDateObj.toISOString().split("T")[0];

  try {
    const res = await fetch(`https://api.frankfurter.app/${startDate}..${endDate}?from=USD&to=EUR`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();

    localStorage.setItem(CACHE_365_KEY, JSON.stringify(data));
    localStorage.setItem(CACHE_365_DATE_KEY, today);

    return data;
  } catch (error) {
    console.warn("Failed to fetch 365-day rates, falling back to cache if any", error);
    if (cachedData) return JSON.parse(cachedData);
    throw error;
  }
}

function displayChart(data) {
  const dates = Object.keys(data.rates).sort();
  const rates = dates.map(date => data.rates[date].EUR);

  const ctx = document.getElementById('rateChart').getContext('2d');

  if(window.rateChartInstance) {
    window.rateChartInstance.data.labels = dates;
    window.rateChartInstance.data.datasets[0].data = rates;
    window.rateChartInstance.update();
  } else {
    window.rateChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [{
          label: 'USD to EUR Exchange Rate (365 days)',
          data: rates,
          borderColor: '#007bff',
          backgroundColor: 'rgba(0,123,255,0.1)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        scales: {
          x: { display: false },
          y: {
            title: { display: true, text: 'EUR per USD' }
          }
        }
      }
    });
  }
}

function getCachedCurrentRate() {
  const rate = localStorage.getItem(CACHE_CURR_RATE_KEY);
  const rateDate = localStorage.getItem(CACHE_CURR_RATE_DATE_KEY);
  if (rate && rateDate) {
    return { rate: parseFloat(rate), date: rateDate };
  }
  return null;
}

async function fetchCurrentRate() {
  try {
    const response = await fetch("https://api.frankfurter.app/latest?from=USD&to=EUR");
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const data = await response.json();
    const rate = data.rates.EUR;
    localStorage.setItem(CACHE_CURR_RATE_KEY, rate);
    localStorage.setItem(CACHE_CURR_RATE_DATE_KEY, today);
    return rate;
  } catch (error) {
    console.warn("Failed to fetch current rate:", error);
    return null;
  }
}

async function showExchangeRate() {
  const rateDiv = document.getElementById("exchangeRate");
  const cached = getCachedCurrentRate();

  if (cached) {
    rateDiv.innerText = `Current Exchange Rate (cached ${cached.date}): 1 USD = ${cached.rate.toFixed(4)} EUR`;
  } else {
    rateDiv.innerText = "Loading exchange rate...";
  }
}

async function init() {
  showExchangeRate();

  try {
    const rates365 = await fetch365DayRates();
    displayChart(rates365);
  } catch {
    // Already handled fallback in fetch365DayRates()
  }
}

// Called when user clicks "Convert"
async function convertCurrency() {
  const usdAmount = parseFloat(document.getElementById('usd').value);
  const resultDiv = document.getElementById('result');

  if (isNaN(usdAmount)) {
    resultDiv.innerText = "Please enter a valid number.";
    return;
  }

  // Try fresh current rate fetch on demand
  let rate = await fetchCurrentRate();

  if (rate) {
    // Success: update display and cache already done in fetchCurrentRate()
    document.getElementById("exchangeRate").innerText = `Current Exchange Rate: 1 USD = ${rate.toFixed(4)} EUR`;
  } else {
    // Fallback to cached rate if available
    const cached = getCachedCurrentRate();
    if (cached) {
      rate = cached.rate;
      document.getElementById("exchangeRate").innerText = `Current Exchange Rate (cached ${cached.date}): 1 USD = ${rate.toFixed(4)} EUR (offline)`;
    } else {
      resultDiv.innerText = "Unable to get exchange rate now, please try again later.";
      return;
    }
  }

  const eurAmount = usdAmount * rate;
  resultDiv.innerText = `${usdAmount.toFixed(2)} USD = ${eurAmount.toFixed(2)} EUR`;
}

// Run on page load
init();
